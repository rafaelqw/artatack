"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const model_1 = require("./model");
function append(table, data, config, defaults) {
    const db = table.db;
    const model = table.model;
    const row = table.append();
    const defaultMap = new Map();
    const rowMap = new Map();
    for (const key in data) {
        const value = data[key];
        if (value === undefined)
            continue;
        if (key in config) {
            const setField = selector => {
                let _model = model;
                let _row = row;
                let _defaults = defaults;
                const names = selector.split('.');
                for (let i = 0; i < names.length - 1; i++) {
                    _defaults = _defaults && _defaults[names[i]];
                    const path = names.slice(0, i + 1).join('.');
                    const row = rowMap.get(path);
                    if (row) {
                        _row = row;
                    }
                    else {
                        _row = getRecordField(_row, _model.field(names[i]));
                        rowMap.set(path, _row);
                        if (_model.field(names[i]) instanceof model_1.RelatedField && _defaults) {
                            defaultMap.set(_row, _defaults);
                        }
                    }
                    _model = _row.__table.model;
                }
                const field = _model.field(names[names.length - 1]);
                if (field instanceof model_1.ForeignKeyField) {
                    _row[names[names.length - 1]] = value || null;
                }
                else {
                    _row[names[names.length - 1]] = value;
                }
            };
            if (Array.isArray(config[key])) {
                for (const name of config[key]) {
                    setField(name);
                }
            }
            else {
                setField(config[key]);
            }
        }
        else {
            // "*": "categoryAttributes[name,value]"
            if (!config['*']) {
                throw Error(`Unknown field: ${key}`);
            }
            const option = parseRelatedOption(config['*']);
            const field = model.field(option.name);
            if (field instanceof model_1.RelatedField) {
                const table = db.table(field.referencingField.model);
                let record = table.append();
                record[field.referencingField.name] = row;
                if (option.value) {
                    record[option.key] = key;
                    record[option.value] = value;
                }
                else {
                    if (!field.throughField) {
                        record[option.key] = value;
                    }
                    else {
                        const referencedField = field.throughField.referencedField;
                        const referencedTable = db.table(referencedField.model);
                        const referencedRecord = referencedTable.append();
                        referencedRecord[option.key] = value;
                        record[field.throughField.name] = referencedRecord;
                        record = referencedRecord;
                    }
                }
                const _defaults = defaults && defaults[field.name];
                if (_defaults) {
                    setDefaults(record, _defaults);
                }
            }
            else {
                throw Error(`Invalid field: ${model.name}.${key}`);
            }
        }
    }
    if (defaults) {
        setDefaults(row, defaults);
        defaultMap.forEach((defaults, row) => {
            setDefaults(row, defaults);
        });
    }
    return row;
}
function getRecordField(row, field) {
    const db = row.__table.db;
    if (field instanceof model_1.ForeignKeyField) {
        if (!row[field.name]) {
            row[field.name] = db.table(field.referencedField).append();
        }
        return row[field.name];
    }
    else if (field instanceof model_1.RelatedField) {
        if (field.throughField) {
            const record = db
                .table(field.throughField.referencedField.model)
                .append();
            const bridge = db.table(field.referencingField.model).append();
            bridge[field.referencingField.name] = row;
            bridge[field.throughField.name] = record;
            return record;
        }
        else {
            const table = db.table(field.referencingField.model);
            const record = table.append();
            record[field.referencingField.name] = row;
            return record;
        }
    }
    throw Error(`Invalid field: ${field && field.displayName()}`);
}
function setDefaults(row, defaults) {
    for (const name in defaults) {
        const field = row.__table.model.field(name);
        const value = defaults[name];
        if (field instanceof model_1.ForeignKeyField) {
            if (row[name] === undefined) {
                if (value === null) {
                    row[name] = null;
                    continue;
                }
                row[name] = row.__table.db.table(field.referencedField.model).append();
            }
            if (typeof value === 'object' && !(value instanceof Date)) {
                setDefaults(row[name], value);
            }
            else {
                row[name].__setPrimaryKey(value);
            }
        }
        else if (field instanceof model_1.SimpleField) {
            if (row[name] === undefined) {
                row[name] = value;
            }
        }
    }
}
function parseRelatedOption(spec) {
    // "categoryAttributes[name,value]"
    const [name, optional] = spec.split('[');
    if (optional) {
        const parts = optional.replace(/\]\s*$/, '').split(',');
        return {
            name,
            key: parts[0].trim(),
            value: parts[1] && parts[1].trim()
        };
    }
    return {
        name,
        key: 'name',
        value: 'value'
    };
}
exports.parseRelatedOption = parseRelatedOption;
function loadTable(table, data, config, defaults) {
    if (Array.isArray(data)) {
        for (const row of data) {
            append(table, row, config, defaults);
        }
    }
    else {
        append(table, data, config, defaults);
    }
    return table.db.flush();
}
exports.loadTable = loadTable;
function recordConfigToDocument(table, config) {
    const result = {};
    for (const name in config) {
        let selector;
        if (Array.isArray(config[name])) {
            selector = config[name][0];
        }
        else {
            selector = config[name];
        }
        let names = selector.split('.');
        let model = table.model;
        let fields = result;
        for (let i = 0; i < names.length - 1; i++) {
            const field = model.field(names[i]);
            if (field instanceof model_1.ForeignKeyField) {
                model = field.referencedField.model;
            }
            else {
                const related = field;
                if (related.throughField) {
                    model = related.throughField.referencedField.model;
                }
                else {
                    model = related.referencingField.model;
                }
            }
            if (field instanceof model_1.RelatedField) {
                if (!fields[field.name]) {
                    fields[field.name] = { fields: {} };
                }
                fields = fields[field.name].fields;
            }
            else {
                if (!fields[field.name]) {
                    fields[field.name] = {};
                }
                fields = fields[field.name];
            }
        }
        fields[names[names.length - 1]] = names[names.length - 1];
    }
    return result;
}
exports.recordConfigToDocument = recordConfigToDocument;
function mapDocument(doc, config) {
    const result = [];
    for (const entry of flatten(doc)) {
        const item = {};
        for (const name in config) {
            const path = Array.isArray(config[name]) ? config[name][0] : config[name];
            if (entry[path] !== undefined) {
                item[name] = entry[path];
            }
        }
        result.push(item);
    }
    return result;
}
exports.mapDocument = mapDocument;
function flatten(doc) {
    let result = [{}];
    for (const name in doc) {
        const value = doc[name];
        if (Array.isArray(value)) {
            const next = [];
            if (value.length > 0) {
                for (const val of value) {
                    const docs = flatten(val);
                    for (const doc of docs) {
                        for (const res of result) {
                            const ent = Object.assign({}, res);
                            for (const key in doc) {
                                ent[`${name}.${key}`] = doc[key];
                            }
                            next.push(ent);
                        }
                    }
                }
                result = next;
            }
            else {
                // Keep
            }
        }
        else if (value && typeof value === 'object' && !(value instanceof Date)) {
            const docs = flatten(value);
            const next = [];
            for (const doc of docs) {
                for (const res of result) {
                    const ent = Object.assign({}, res);
                    for (const key in doc) {
                        ent[`${name}.${key}`] = doc[key];
                    }
                    next.push(ent);
                }
            }
            result = next;
        }
        else {
            for (const entry of result) {
                entry[name] = value;
            }
        }
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2xvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLG1DQUE0RTtBQU01RSxnQkFDRSxLQUFZLEVBQ1osSUFBYyxFQUNkLE1BQW9CLEVBQ3BCLFFBQW1CO0lBRW5CLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7SUFDcEIsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUMxQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDM0IsTUFBTSxVQUFVLEdBQTBCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDcEQsTUFBTSxNQUFNLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUM7SUFFOUMsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLEVBQUU7UUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXhCLElBQUksS0FBSyxLQUFLLFNBQVM7WUFBRSxTQUFTO1FBRWxDLElBQUksR0FBRyxJQUFJLE1BQU0sRUFBRTtZQUNqQixNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsRUFBRTtnQkFDMUIsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDO2dCQUNuQixJQUFJLElBQUksR0FBRyxHQUFHLENBQUM7Z0JBQ2YsSUFBSSxTQUFTLEdBQUcsUUFBUSxDQUFDO2dCQUV6QixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUVsQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3pDLFNBQVMsR0FBRyxTQUFTLElBQUssU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBYyxDQUFDO29CQUMzRCxNQUFNLElBQUksR0FBRyxLQUFL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